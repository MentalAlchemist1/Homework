
### 0-auth.tf
Terraform configuration block
This defines the minimum Terraform version and required providers

terraform {
	required_version = ">= 1.0"

	required_providers {
		aws = {
			source = "hashicorp/aws"
			version = "~> 6.0"
		}
	}
}

AWS Provider configuration
This tells Terraform how to connect to AWS

provider "aws" {
	region = "us-west-2"
	profile = "default"

Default tags are applied to all resources created by this provider
default_tags {
	tags = {
		Project = "vpc-demo"
		Environment = "dev"
		ManagedBy = "Terraform"
		}
	}
}

### 1 VPC.tf

resource "aws_vpc" "main" {

   region = ""
   cidr_block = "10.107.0.0/16"

  instance_tenancy = "default"
  enable_dns_hostnames = true
  enable_dns_support = true
  
  tags = {
	Name = "titanlink-vpc"
	}
}


### 2 Subnets
resource "aws_subnet" "public-us-west-2a" {
	vpc_id = aws_vpc.main.id
	cidr_block = "10.107.1.0/24"
	availability_zone = "us-west-2a"
	map_public_ip_on_launch = true

	tags = {
		Name = "public-us-west-2a"
		Service = "application1"
		Owner = "Luke"
		Planet = "Musafar"
	}
}

resource "aws_subnet" "public-us-west-2b" {
	vpc_id = aws_vpc.main.id
	cidr_block = "10.107.2.0/24"
	availability_zone = "us-west-2b"
	map_public_ip_on_launch = true

	tags = {
		Name = "public-us-west-2b"
		Service = "application1"
		Owner = "Luke"
		Planet = "Musafar"
	}
}

resource "aws_subnet" "public-us-west-2c" {
	vpc_id = aws_vpc.main.id
	cidr_block = "10.107.3.0/24"
	availability_zone = "us-west-2c"
	map_public_ip_on_launch = true

	tags = {
		Name = "public-us-west-2c"
		Service = "application1"
		Owner = "Luke"
		Planet = "Musafar"
	}
}

These are for private

resource "aws_subnet" "private-us-west-2a" {
	vpc_id = aws_vpc.main.id
	cidr_block = "10.107.11.0/24"
	availability_zone = "us-west-2a"

	tags = {
		Name = "private-us-west-2a"
		Service = "application1"
		Owner = "Luke"
		Planet = "Musafar"
	}
}

  resource "aws_subnet" "private-us-west-2b" {
	  vpc_id = aws_vpc.main.id
	  cidr_block = "10.107.12.0/24"
	  availability_zone = "us-west-2b"
	
	tags = {
		Name = "private-us-west-2b"
		Service = "application1"
		Owner = "Luke"
		Planet = "Musafar"
	}
}

resource "aws_subnet" "private-us-west-2c" {
	vpc_id = aws_vpc.main.id
	cidr_block = "10.107.13.0/24"
	availability_zone = "us-west-2c"
	
	tags = {
		Name = "private-us-west-2c"
		Service = "application1"
		Owner = "Luke"
		Planet = "Musafar"
	}
}

### 3 IGW

resource "aws_internet_gateway" "igw" {
   vpc_id = aws_vpc.main.id

   tags = {
	   Name = "titanlink_IGW"
	   Service = "application1"
	   Owner = "Luke"
	   Planet = "Musafar"
	}
}


### 4 NAT

resource "aws_eip" "nat" {
  tags = {
	  Name = "nat"
	}
}

resource "aws_nat_gateway" "nat" {
	allocation_id = aws_eip.nat.id
	subnet_id = aws_subnet.public-us-west-2a.id
	tags = {
		Name = "nat"
	}
	
	depends_on = [aws_internet_gateway.igw]
}


### 5 Route

resource "aws_route_table" "private" {
   vpc_id = aws_vpc.main.id
   
   route {
	   cidr_block = "0.0.0.0/0"
	   nat_gateway_id = aws_nat_gateway.nat.id

}

   tags = {
	   Name = "private"
	}
}

resource "aws_route_table" "public" {
   vpc_id = aws_vpc.main.id
   
   route {
	   cidr_block = "0.0.0.0/0"
	   gateway_id = aws_internet_gateway.igw.id

}

tags = {
	Name = "public"
	}
}


resource "aws_route_table_association" "private-us-west-2a" {
	subnet_id = aws_subnet.private-us-west-2a.id
	route_table_id = aws_route_table.private.id
}

resource "aws_route_table_association" "private-us-west-2b" {
	subnet_id = aws_subnet.private-us-west-2b.id
	route_table_id = aws_route_table.private.id
}

resource "aws_route_table_association" "private-us-west-2c" {
	subnet_id = aws_subnet.private-us-west-2c.id
	route_table_id = aws_route_table.private.id
}


public

resource "aws_route_table_association" "public-us-west-2a" {
	subnet_id = aws_subnet.public-us-west-2a.id
	route_table_id = aws_route_table.public.id
}

resource "aws_route_table_association" "public-us-west-2b" {
	subnet_id = aws_subnet.public-us-west-2b.id
	route_table_id = aws_route_table.public.id
}

resource "aws_route_table_association" "public-us-west-2c" {
	subnet_id = aws_subnet.public-us-west-2c.id
	route_table_id = aws_route_table.public.id
}

### 6 SG

resource "aws_security_group" "web_server" {
   name = "web-server"
   description = "Security group for web server with HTTP and ssh"
   vpc_id = aws_vpc.main.id

   tags = {
	Name = "web-server"
	}
}

resource "aws_vpc_security_group_ingress_rule" "http" {
   security_group_id = aws_security_group.web_server.id
   
   cidr_ipv4 = "0.0.0.0/0"
   from_port = 80
   ip_protocol = "tcp"
   to_port = 80
}

resource "aws_vpc_security_group_ingress_rule" "ssh" {
   security_group_id = aws_security_group.web_server.id
   
   cidr_ipv4 = "0.0.0.0/0"
   from_port = 22
   ip_protocol = "tcp"
   to_port = 22
}

resource "aws_vpc_security_group_egress_rule" "egress" {
   security_group_id = aws_security_group.web_server.id
   
   cidr_ipv4 = "0.0.0.0/0"
   ip_protocol = "-1"
}

resource "aws_security_group" "ping" {
   name = "icmp-for-ping"
   description = "Allow icmp for ping"
   vpc_id = aws_vpc.main.id

   tags = {
	   Name = "icmp-for-ping"
	}
}

resource "aws_vpc_security_group_ingress_rule" "icmp" {
	security_group_id = aws_security_group.ping.id
	cidr_ipv4 = "0.0.0.0/0"
	from_port = -1
	ip_protocol = "icmp"
	to_port = -1

}

resource "aws_vpc_security_group_egress_rule" "egress_for_ping" {
   security_group_id = aws_security_group.ping.id
   cidr_ipv4 = "0.0.0.0/0"
   ip_protocol = "-1"
}


### 7 EC2

resource "aws_instance" "web-server" {
   ami = "ami-06d455b8b50b0de4d" # Amazon Linux 2023 AMI ID for us-west-2
   associate_public_ip_address = true
   instance_type = "t3.micro"

key_name =
subnet_id = aws_subnet.public-us-west-2a.id
vpc_security_group_ids = [aws_security_group.web_server.id, aws_security_group.ping.id]

user_data = file("user_data.sh")

tags = {
	Name = "web-server"
	}
}

### 8 Output

output "ip_address" {
	value = aws_instance.web-server.public_ip
}

output "website_url" {
	value = "http://${aws_instance.web-server.public_dns}"

}